apiVersion: v1
kind: ConfigMap
metadata:
  name: clickvisual-config
data:
  default.toml: |
    # Configurações da Aplicação
    [app]
    secretKey = "secretKey" # hashStatecode - ALTERAR EM PRODUÇÃO
    rootURL = "http://clickvisual.production-observability.svc.cluster.local"
    baseURL = "/api/admin/login/"
    permissionFile = "/clickvisual/config/resource.yaml"

    # Configurações de Autorização
    [casbin.rule]
    path = "/clickvisual/config/rbac.conf"

    # Configurações do Servidor HTTP
    # [server]
    # port = 3001

    [server.http]
    host = "0.0.0.0"
    port = 3001
    # embedPath = "dist"
    maxAge = 86400

    [server.governor]
    host = "0.0.0.0"
    port = 19011

    # Configurações de Log
    [logger]
    level = "debug"
    name = "clickvisual.log"

    # Configurações do MySQL
    [mysql]
    connMaxLifetime = "300s"
    debug = false  # Changed from true to false
    dsn = "root:root123@tcp(mysql.production-database.svc.cluster.local:3306)/clickvisual?charset=utf8mb4&collation=utf8mb4_general_ci&parseTime=True&loc=Local&timeout=10s"
    level = "error"  # Changed from panic to error
    maxIdleConns = 10  # Reduced from 50
    maxOpenConns = 20  # Reduced from 100

    # Configurações de Autenticação
    [auth]
    mode = "memstore" # redis ou memstore
    name = "clickvisual_session"
    debug = true
    Keypairs = "secret-change-this-in-production"
    # Se usar modo redis, descomente abaixo:
    # redisSize = 10
    # redisNetwork = "tcp"
    # redisAddr = ""
    # redisPassword = ""

    [auth.anonymous]
    enabled = false

    [auth.proxy]
    enabled = false
    isAutoLogin = false
    headerName = "X-CLICKVISUAL-USER"
    headerNickName = "X-CLICKVISUAL-NICKNAME"
    rootTokenKey = "X-CLICKVISUAL-TOKEN"
    rootTokenValue = "xxx"

    # Configurações OAuth (desabilitadas por padrão)
    [[auth.tps]]
    typ = "github"
    enable = false
    allowSignUp = true
    clientId = ""
    clientSecret = ""
    scopes = ["user:email", "read:org"]
    authUrl = "https://github.com/login/oauth/authorize"
    tokenUrl = "https://github.com/login/oauth/access_token"
    apiUrl = "https://api.github.com/user"
    allowedDomains = []
    teamIds = []
    allowedOrganizations = []

    [[auth.tps]]
    typ = "gitlab"
    enable = false
    allowSignUp = true
    clientId = ""
    clientSecret = ""
    scopes = ["api"]
    authUrl = "https://gitlab.com/oauth/authorize"
    tokenUrl = "https://gitlab.com/oauth/token"
    apiUrl = "https://gitlab.com/api/v4"
    allowedDomains = []
    teamIds = []
    allowedOrganizations = []

    # Integração Prometheus para ClickHouse (desabilitada)
    [prom2click]
    enable = false

    [[prom2click.cfgs]]
    host = "0.0.0.0"
    port = 19006
    clickhouseDSN = "tcp://clickhouse:9000?username=default&read_timeout=10&write_timeout=10&debug=true"
    clickhouseDB = "metrics"
    clickhouseTable = "samples"

    # Configurações do ClickHouse
    [clickhouse]
    host = "clickhouse"
    port = 8123
    database = "default"
    username = "default"  # Usuário padrão do ClickHouse
    password = ""  # Senha vazia para o usuário default

    # Conexão padrão do ClickHouse para queries
    [defaultCh]
    dsn = "clickhouse://default:@clickhouse:8123/default?max_execution_time=60"
  resource.yaml: |
    permission:
      - name: log
        path: /query
        api:
          - name: 获取日志列表
            method: GET
            path: /api/query/logs
          - name: 获取日志图表
            method: GET
            path: /api/query/charts
          - name: 获取日志tables
            method: GET
            path: /api/query/tables
      - name: alarm
        path: /alarm
        children:
          - name: rules
            path: /alarm/rules
          - name: environment
            path: /alarm/environment
          - name: notifications
            path: /alarm/notifications
      - name: configure
        path: /configure
      - name: bigdata
        path: /bigdata
      - name: systemSettings
        path: /sys
        children:
          - path: /sys/instances
            name: database
            api:
            - name: 查询数据库连接
              method: GET
              path: /api/sys/instances
            - name: 新增数据库连接
              method: POST
              path: /api/sys/instances
            - name: 更新数据库连接
              method: PATCH
              path: /api/sys/instances/:id
            - name: 删除数据库连接
              method: DELETE
              path: /api/sys/instances/:id
          - path: /sys/clusters
            name: cluster
            api:
            - name: 查询数据库连接
              method: GET
              path: /api/v1/sys/clusters
            - name: 新增数据库连接
              method: POST
              path: /api/v1/sys/clusters
            - name: 更新数据库连接
              method: PATCH
              path: /api/v1/sys/clusters/:id
            - name: 删除数据库连接
              method: DELETE
              path: /api/v1/sys/clusters/:id
          - name: events
            path: /sys/events
          - name: pms
            path: /sys/pms
            api:
              - path: /api/v1/pms/commonInfo
                name: 获取权限常量信息
                method: GET
              - path: /api/v1/pms/defaultRole/list
                name: 全局默认角色列表
                method: GET
              - path: /api/v1/pms/app/:id/role/grant
                name: 获取应用的角色授权信息
                method: GET
              - path: /api/v1/pms/app/:id/role/grant
                name: 获取应用的角色授权信息
                method: PUT
              - path: /api/v1/pms/role
                name: 获取权限角色列表
                method: GET
              - path: /api/v1/pms/role/:id
                name: 获取指定权限角色
                method: GET
              - path: /api/v1/pms/role
                name: 创建权限角色
                method: POST
              - path: /api/v1/pms/role/:id
                name: 更新指定权限角色
                method: PUT
              - path: /api/v1/pms/role/:id
                name: 删除权限角色
                method: DELETE
              - path: /api/v1/pms/root/uids
                name: 获取超级管理员用户id
                method: GET
              - path: /api/v1/pms/root/grant
                name: 授权超级管理员
                method: POST
              - path: /api/v1/pms/check
                name: 查询权限
                method: POST
          - name: user
            path: /sys/user
  rbac.conf: |
    [request_definition]
    r = sub, obj, act, dom

    [policy_definition]
    p = sub, obj, act, dom

    [role_definition]
    g = _, _, _
    g2 = _, _
    g3 = _, _

    [policy_effect]
    e = some(where (p.eft == allow))

    [matchers]
    m = (g(r.sub, p.sub, r.dom) || g3(r.sub, p.sub)) \
    && (g2(r.obj, p.obj) || keyMatch(r.obj, p.obj) || keyMatch2(r.obj, p.obj)) \
    && keyMatch(r.dom, p.dom) \
    && (p.act == 'edit' && r.act == 'view' || keyMatch(r.act, p.act) || keyMatch2(r.act, p.act)) \
    || (g3(r.sub, p.sub) && p.sub == "role__root")