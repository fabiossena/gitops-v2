apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  labels:
    app.kubernetes.io/name: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana
  template:
    metadata:
      labels:
        app.kubernetes.io/name: grafana
    spec:
      initContainers:
      - name: download-dashboards
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          apk add --no-cache jq
          DASHBOARDS_DIR="/dashboards"
          IDS_CONFIG="/config/dashboard-ids.json"
          
          # Criar diretório se não existir
          mkdir -p "$DASHBOARDS_DIR"
          
          echo "Downloading dashboards from Grafana.com..."
          echo "Dashboard directory: $DASHBOARDS_DIR"
          echo "IDs config file: $IDS_CONFIG"
          
          # Verificar se o arquivo de IDs existe
          if [ ! -f "$IDS_CONFIG" ]; then
            echo "ERROR: dashboard-ids.json not found at $IDS_CONFIG"
            echo "Available files in /config:"
            ls -la /config/ || echo "Config directory not found"
            exit 0
          fi
          
          echo "Found dashboard-ids.json, content:"
          cat "$IDS_CONFIG"
          
          # Ler lista de IDs e baixar cada dashboard
          failed=0
          while IFS= read -r dashboard; do
            id=$(echo "$dashboard" | jq -r '.id')
            name=$(echo "$dashboard" | jq -r '.name')
            title=$(echo "$dashboard" | jq -r '.title')
            
            echo "Downloading dashboard ID $id: $title..."
            
            # Baixar o dashboard do Grafana.com API com retry
            for i in 1 2 3; do
              if curl -sSL "https://grafana.com/api/dashboards/$id/revisions/1/download" \
                -o "$DASHBOARDS_DIR/$name"; then
                # Validar que o arquivo JSON é válido
                if jq empty "$DASHBOARDS_DIR/$name" 2>/dev/null; then
                  echo "✓ Successfully downloaded and validated $name"
                  break
                else
                  echo "⚠ Downloaded but invalid JSON: $name, retrying..."
                  rm -f "$DASHBOARDS_DIR/$name"
                  if [ $i -eq 3 ]; then
                    echo "✗ Failed to download valid $name after 3 attempts"
                    failed=$((failed + 1))
                  fi
                fi
              else
                if [ $i -eq 3 ]; then
                  echo "✗ Failed to download $name after 3 attempts, continuing..."
                  failed=$((failed + 1))
                else
                  echo "Retry $i/3 for $name..."
                  sleep 2
                fi
              fi
            done
          done < <(jq -c '.[]' "$IDS_CONFIG")
          
          # Listar arquivos baixados para debug
          echo "=== Downloaded dashboards ==="
          ls -lah "$DASHBOARDS_DIR/" 2>/dev/null || echo "No dashboards directory found"
          echo "File count: $(ls -1 "$DASHBOARDS_DIR/" 2>/dev/null | wc -l)"
          echo "=============================="
          
          # Verificar se os arquivos são válidos JSON e têm o formato esperado pelo Grafana
          echo "=== Validating dashboard JSONs ==="
          for json_file in "$DASHBOARDS_DIR"/*.json; do
            if [ -f "$json_file" ]; then
              echo "Validating: $(basename "$json_file")"
              # Verificar se tem "dashboard" ou é um objeto JSON válido
              if jq empty "$json_file" 2>/dev/null; then
                # Verificar se tem campo "dashboard" ou é um dashboard direto
                if jq -e '.dashboard' "$json_file" >/dev/null 2>&1 || jq -e '.uid' "$json_file" >/dev/null 2>&1; then
                  echo "✓ Valid dashboard JSON: $(basename "$json_file")"
                else
                  echo "⚠ JSON válido mas pode não ser um dashboard: $(basename "$json_file")"
                fi
              else
                echo "✗ Invalid JSON: $(basename "$json_file")"
              fi
            fi
          done
          echo "================================="
          
          if [ $failed -gt 0 ]; then
            echo "Warning: $failed dashboard(s) failed to download, but continuing..."
          fi
          
          echo "All dashboards processed!"
        volumeMounts:
        - name: dashboards
          mountPath: /dashboards
        - name: dashboard-ids
          mountPath: /config
      containers:
      - name: grafana
        image: grafana/grafana:10.2.0
        ports:
        - containerPort: 3000
        env:
        - name: GF_SECURITY_ADMIN_USER
          valueFrom:
            secretKeyRef:
              name: grafana-admin
              key: admin-user
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-admin
              key: admin-password
        - name: GF_PATHS_PROVISIONING
          value: /etc/grafana/provisioning
        - name: GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH
          value: /etc/grafana/provisioning/dashboards/default
        volumeMounts:
        - name: datasources
          mountPath: /etc/grafana/provisioning/datasources
          readOnly: true
        - name: dashboard-provider
          mountPath: /etc/grafana/provisioning/dashboards
          readOnly: true
        - name: dashboards
          mountPath: /etc/grafana/provisioning/dashboards/default
          readOnly: true
        - name: storage
          mountPath: /var/lib/grafana
        resources:
          limits:
            memory: 512Mi
            cpu: 500m
          requests:
            memory: 256Mi
            cpu: 200m
      volumes:
      - name: datasources
        configMap:
          name: grafana-datasources
      - name: dashboard-provider
        configMap:
          name: grafana-dashboard-provider
      - name: dashboard-ids
        configMap:
          name: grafana-dashboard-ids
      - name: dashboards
        emptyDir: {}
      - name: storage
        emptyDir: {}