---
# ArgoCD installation via Kustomization manifest in K3s auto-apply directory
- name: Create ArgoCD namespace - teste1
  debug:
    msg: "kubeconfig_path = {{ kubeconfig_path }}"

- name: Create ArgoCD namespace - teste2
  shell: "ls {{ kubeconfig_path }}"
  register: kube_ls

- name: Show ls result
  debug:
    var: kube_ls.stdout
    




- name: Create ArgoCD namespace
  shell: kubectl create namespace {{ argocd_namespace }}
  args:
    creates: /var/lib/rancher/k3s/server/manifests/argocd-ns.yaml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  # ignore_errors: yes

- name: Install ArgoCD via Kustomization manifest
  template:
    src: argocd-install.yaml.j2
    dest: /var/lib/rancher/k3s/server/manifests/argocd.yaml

- name: Deploy App of Apps
  template:
    src: app-of-apps.yaml.j2
    dest: /var/lib/rancher/k3s/server/manifests/app-of-apps.yaml

- name: Wait for ArgoCD namespace to be created
  shell: |
    /usr/local/bin/k3s kubectl get ns {{ argocd_namespace }}
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: argocd_ns_check
  until: argocd_ns_check.rc == 0
  retries: 20
  delay: 5
  changed_when: false

- name: Wait for ArgoCD pods to be ready
  shell: |
    /usr/local/bin/k3s kubectl get pods -n {{ argocd_namespace }} \
      -l app.kubernetes.io/name=argocd-server \
      -o jsonpath='{.items[0].status.phase}' 2>/dev/null | grep -q Running
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: argocd_pod_check
  until: argocd_pod_check.rc == 0
  retries: 30
  delay: 10
  changed_when: false
  # ignore_errors: yes

- name: Wait a few more seconds for secret to be ready
  pause:
    seconds: 5

- name: Get ArgoCD initial admin password
  shell: |
    /usr/local/bin/k3s kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret \
      -o jsonpath="{.data.password}" 2>/dev/null | base64 -d
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: argocd_password
  changed_when: false
  # ignore_errors: yes

- name: Get ArgoCD service port
  shell: |
    /usr/local/bin/k3s kubectl -n {{ argocd_namespace }} get svc argocd-server \
      -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}' 2>/dev/null || echo "30443"
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: argocd_port
  changed_when: false
  # ignore_errors: yes

- name: Get node IP
  shell: |
    /usr/local/bin/k3s kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}' 2>/dev/null || hostname -I | awk '{print $1}'
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: node_ip
  changed_when: false
  # ignore_errors: yes

- name: Display ArgoCD access information
  debug:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘          ğŸ¯ ArgoCD Installation Complete! ğŸ¯             â•‘
      â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
      â•‘ URL:        https://{{ node_ip.stdout }}:{{ argocd_port.stdout }}
      â•‘ Username:   admin
      â•‘ Password:   {{ argocd_password.stdout }}
      â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
      â•‘ Namespace:  {{ argocd_namespace }}
      â•‘ Version:    {{ argocd_version }}
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      To access ArgoCD:
      1. Open browser: https://{{ node_ip.stdout }}:{{ argocd_port.stdout }}
      2. Login: admin / {{ argocd_password.stdout }}
      3. Ignore self-signed certificate warning
      
      To retrieve password later:
      k3s kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
  when: argocd_password.stdout is defined and argocd_password.stdout != ""