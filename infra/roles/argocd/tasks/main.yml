---
- name: Verificar conexão com cluster Kubernetes
  command: kubectl cluster-info
  register: cluster_info
  failed_when: false
  
- name: Criar namespace para ArgoCD
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ argocd_namespace }}"
    state: present
  when: cluster_info.rc == 0

- name: Instalar ArgoCD via Helm
  kubernetes.core.helm:
    name: argocd
    namespace: "{{ argocd_namespace }}"
    chart_ref: argo/argo-cd
    chart_version: "{{ argocd_version }}"
    release_namespace: "{{ argocd_namespace }}"
    create_namespace: no
    update_cache: yes
    state: present

- name: Aguardar pods do ArgoCD estarem prontos
  kubernetes.core.k8s_info:
    kind: Pod
    namespace: "{{ argocd_namespace }}"
    label_selectors:
      - app.kubernetes.io/name = argocd-server
  register: argocd_pods
  until: argocd_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: 20
  delay: 10

- name: Expor serviço ArgoCD via LoadBalancer (opcional)
  kubernetes.core.k8s:
    api_version: v1
    kind: Service
    namespace: "{{ argocd_namespace }}"
    name: argocd-server
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: argocd-server
        namespace: "{{ argocd_namespace }}"
      spec:
        ports:
          - port: 80
            targetPort: 8080
            protocol: TCP
            name: http
          - port: 443
            targetPort: 8080
            protocol: TCP
            name: https
        selector:
          app.kubernetes.io/name: argocd-server
        type: LoadBalancer
  when: cluster_info.rc == 0

- name: Recuperar senha inicial do ArgoCD
  command: >
    kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret
    -o jsonpath='{.data.password}' | base64 -d
  register: argocd_password
  when: cluster_info.rc == 0

- name: Exibir informações de acesso
  debug:
    msg:
      - "ArgoCD instalado com sucesso!"
      - "Namespace: {{ argocd_namespace }}"
      - "Senha do admin: {{ argocd_password.stdout }}"
      - "Para acessar: kubectl port-forward svc/argocd-server -n {{ argocd_namespace }} 8080:443"
      - "Ou acesse via LoadBalancer se configurado"
  when: cluster_info.rc == 0 and argocd_password.stdout != ""