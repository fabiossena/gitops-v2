# roles/argocd/tasks/main.yml
---
- name: Configurar ambiente para K3s
  set_fact:
    k3s_kubeconfig: /etc/rancher/k3s/k3s.yaml
    k3s_api_url: https://127.0.0.1:6443

- name: Copiar kubeconfig do K3s para usuÃ¡rio local
  become: yes
  copy:
    src: "{{ k3s_kubeconfig }}"
    dest: "~/.kube/config"
    remote_src: yes
    mode: '0600'

- name: Ajustar kubeconfig para apontar para localhost
  shell: |
    sed -i 's/server: .*/server: https:\/\/127.0.0.1:6443/' ~/.kube/config
  register: kubeconfig_update

- name: Verificar conexÃ£o com cluster K3s
  command: kubectl cluster-info
  register: cluster_info
  failed_when: false
  ignore_errors: yes
  environment:
    KUBECONFIG: ~/.kube/config

- name: Verificar se podemos acessar o cluster
  debug:
    msg: "Cluster K3s acessÃ­vel: {{ cluster_info.rc == 0 }}"
    var: cluster_info.stdout_lines

- name: Criar namespace para ArgoCD usando kubectl
  command: |
    kubectl create namespace {{ argocd_namespace }} --dry-run=client -o yaml | kubectl apply -f -
  environment:
    KUBECONFIG: ~/.kube/config
  register: namespace_result
  changed_when: "'created' in namespace_result.stdout or 'configured' in namespace_result.stdout"
  when: cluster_info.rc == 0

- name: Instalar Helm se necessÃ¡rio
  block:
    - name: Verificar se Helm estÃ¡ instalado
      command: helm version --short
      register: helm_check
      failed_when: false
      changed_when: false
    
    - name: Instalar Helm
      shell: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      when: helm_check.rc != 0
      args:
        creates: /usr/local/bin/helm
  become: yes

- name: Adicionar repositÃ³rio Helm do Argo
  command: helm repo add argo https://argoproj.github.io/argo-helm
  environment:
    KUBECONFIG: ~/.kube/config
  register: helm_repo_add
  changed_when: helm_repo_add.rc == 0
  when: cluster_info.rc == 0

- name: Atualizar repositÃ³rios Helm
  command: helm repo update
  environment:
    KUBECONFIG: ~/.kube/config
  when: cluster_info.rc == 0

- name: Instalar ArgoCD com Helm
  command: |
    helm upgrade --install argocd argo/argo-cd \
      --namespace {{ argocd_namespace }} \
      --version {{ argocd_version }} \
      --set server.service.type=NodePort \
      --set server.service.nodePortHttp=30080 \
      --set server.service.nodePortHttps=30443 \
      --set server.ingress.enabled=false \
      --create-namespace \
      --wait
  environment:
    KUBECONFIG: ~/.kube/config
  register: helm_install
  changed_when: "'deployed' in helm_install.stdout"
  when: cluster_info.rc == 0
  retries: 3
  delay: 10

- name: Aguardar pods do ArgoCD
  shell: |
    timeout 300 bash -c '
    until kubectl get pods -n {{ argocd_namespace }} -l app.kubernetes.io/name=argocd-server -o jsonpath="{.items[*].status.phase}" | grep -q Running; do
      echo "Aguardando pods do ArgoCD...";
      sleep 10;
    done'
  environment:
    KUBECONFIG: ~/.kube/config
  register: wait_pods
  changed_when: wait_pods.rc == 0
  when: cluster_info.rc == 0

- name: Obter senha inicial do ArgoCD
  command: |
    kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret \
      -o jsonpath="{.data.password}" | base64 -d
  environment:
    KUBECONFIG: ~/.kube/config
  register: argocd_password
  failed_when: false
  changed_when: false
  when: cluster_info.rc == 0

- name: Configurar port-forward para acesso
  shell: |
    kubectl port-forward svc/argocd-server -n {{ argocd_namespace }} 8080:443 &
    echo $! > /tmp/argocd-port-forward.pid
    sleep 3
  environment:
    KUBECONFIG: ~/.kube/config
  async: 3600
  poll: 0
  when: cluster_info.rc == 0

- name: Exibir informaÃ§Ãµes de acesso
  debug:
    msg:
      - "ğŸ‰ ArgoCD instalado com sucesso no K3s!"
      - "ğŸ“ Namespace: {{ argocd_namespace }}"
      - "ğŸ”‘ Senha do admin: {{ argocd_password.stdout if argocd_password.stdout is defined else 'Execute: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=\"{.data.password}\" | base64 -d' }}"
      - "ğŸŒ URL local: https://localhost:8080"
      - "ğŸŒ URL NodePort: http://localhost:30080 (HTTP) ou https://localhost:30443 (HTTPS)"
      - "ğŸ‘¤ UsuÃ¡rio: admin"
      - ""
      - "Para parar o port-forward: kill $(cat /tmp/argocd-port-forward.pid)"