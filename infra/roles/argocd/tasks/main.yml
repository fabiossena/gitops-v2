- name: Create ArgoCD namespace
  shell: kubectl create namespace {{ argocd_namespace }}
  args:
    creates: /var/lib/rancher/k3s/server/manifests/argocd-ns.yaml

- name: Install ArgoCD
  template:
    src: argocd-install.yaml.j2
    dest: /var/lib/rancher/k3s/server/manifests/argocd.yaml

- name: Deploy App of Apps
  template:
    src: app-of-apps.yaml.j2
    dest: /var/lib/rancher/k3s/server/manifests/app-of-apps.yaml

- name: Wait for ArgoCD namespace creation
  shell: |
    /usr/local/bin/k3s kubectl get ns {{ argocd_namespace }}
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: argocd_ns_wait
  until: argocd_ns_wait.rc == 0
  retries: 10
  delay: 5
  changed_when: false
  ignore_errors: yes

- name: Show ArgoCD namespace status
  debug:
    msg: "ArgoCD namespace {{ argocd_namespace }} is ready for deployment"
