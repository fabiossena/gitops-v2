# roles/k3s/tasks/main.yml
- name: Parar K3s se estiver rodando
  systemd:
    name: k3s
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Rodar script de desinstalação do K3s
  shell: |
    if [ -f /usr/local/bin/k3s-uninstall.sh ]; then
      /usr/local/bin/k3s-uninstall.sh
    fi
  ignore_errors: yes

- name: Remover diretórios antigos do K3s
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/rancher/k3s
    - /var/lib/rancher/k3s
    - /var/lib/kubelet
    - /etc/systemd/system/k3s.service
    - /etc/systemd/system/k3s.service.env

- name: Instalar K3s (master)
  shell: |
    curl -sfL https://get.k3s.io | sh -
  args:
    creates: /usr/local/bin/k3s
  register: k3s_install
  retries: 3
  delay: 10
  until: k3s_install is succeeded

- name: Aguardar K3s inicializar
  wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    timeout: 60
  ignore_errors: true

- name: Garantir que K3s está ativo
  systemd:
    name: k3s
    state: started
    enabled: yes
  register: k3s_start
  retries: 3
  delay: 5
  until: k3s_start is succeeded

- name: Verificar status do K3s
  shell: k3s kubectl get nodes
  register: k3s_status
  failed_when: "'Ready' not in k3s_status.stdout"

- name: Mostrar status final do cluster
  debug:
    msg: "{{ k3s_status.stdout }}"
