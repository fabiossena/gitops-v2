# roles/k3s/tasks/main.yml
- name: Instalar K3s Master
  hosts: k3s_master
  become: yes
  tasks:
    - name: Parar K3s se estiver rodando
      systemd:
        name: k3s
        state: stopped
        enabled: no
      ignore_errors: yes

    - name: Rodar script de desinstalação do K3s
      shell: |
        if [ -f /usr/local/bin/k3s-uninstall.sh ]; then
          /usr/local/bin/k3s-uninstall.sh
        fi
      ignore_errors: yes

    - name: Remover diretórios antigos do K3s
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/rancher/k3s
        - /var/lib/rancher/k3s
        - /var/lib/kubelet
        - /etc/systemd/system/k3s.service
        - /etc/systemd/system/k3s.service.env

    - name: Instalar pacotes necessários
      apt:
        name:
          - curl
          - iptables
          - iproute2
          - socat
          - conntrack
          - util-linux
        state: present
        update_cache: yes

    - name: Carregar módulos de kernel necessários
      shell: |
        modprobe br_netfilter
        modprobe overlay

    - name: Aplicar sysctl
      shell: sysctl --system

    - name: Instalar K3s (master)
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="v1.27.10+k3s1" sh -
      args:
        creates: /usr/local/bin/k3s
      register: k3s_install
      retries: 3
      delay: 10
      until: k3s_install.rc == 0

    - name: Aguardar K3s inicializar
      wait_for:
        path: /etc/rancher/k3s/k3s.yaml
        timeout: 300

    - name: Garantir que K3s está ativo
      systemd:
        name: k3s
        state: started
        enabled: yes
      register: k3s_start
      retries: 3
      delay: 5
      until: k3s_start.rc == 0

    - name: Verificar status do K3s
      shell: k3s kubectl get nodes
      register: k3s_status
      retries: 10
      delay: 15
      until: "'Ready' in k3s_status.stdout"

    - name: Mostrar status final do cluster
      debug:
        msg: "{{ k3s_status.stdout }}"
