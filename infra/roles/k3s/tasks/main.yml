---
- name: Instalar K3s Master - Limpeza Prévia
  hosts: k3s_master
  become: yes
  tasks:

    - name: Parar K3s se estiver rodando
      systemd:
        name: k3s
        state: stopped
        enabled: no
      ignore_errors: yes

    - name: Rodar script de desinstalação do K3s
      shell: |
        if [ -f /usr/local/bin/k3s-uninstall.sh ]; then
          /usr/local/bin/k3s-uninstall.sh
        fi
      ignore_errors: yes

    - name: Remover diretórios antigos do K3s
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/rancher/k3s
        - /var/lib/rancher/k3s
        - /var/lib/kubelet
        - /etc/systemd/system/k3s.service
        - /etc/systemd/system/k3s.service.env

    # | INSTALL_K3S_VERSION="v1.27.10+k3s1" sh -
    - name: Instalar K3s (master)
      shell: |
        curl -sfL https://get.k3s.io 
      args:
        creates: /usr/local/bin/k3s

    - name: Garantir que K3s está ativo
      systemd:
        name: k3s
        state: started
        enabled: yes

    - name: Verificar status do K3s
      shell: |
        k3s kubectl get nodes
      register: k3s_status
      failed_when: "'Ready' not in k3s_status.stdout"

    - name: Mostrar status final do cluster
      debug:
        msg: "{{ k3s_status.stdout }}"
